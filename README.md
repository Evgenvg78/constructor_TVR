# Constructor TVR

Система конструирования и анализа торговых роботов на основе файлов формата TVR2. Проект предоставляет инструменты для работы с торговыми стратегиями, их параметризации, тестирования и генерации конфигураций для автоматической торговли.

## Описание проекта

**Constructor TVR** — это комплексная система для:
- Конвертации и обработки файлов формата TVR2 (специализированный формат для описания торговых роботов)
- Создания шаблонов торговых стратегий с возможностью параметризации
- Автоматической генерации конфигураций роботов на основе рыночных данных
- Управления портфелями инструментов с интеграцией к MOEX API
- Анализа и тестирования торговых стратегий

Система поддерживает полный цикл разработки торговых роботов: от создания базовых шаблонов до генерации готовых к использованию конфигураций.

## Используемые технологии

### Основные библиотеки
- **pandas** — обработка и анализ данных
- **numpy** — численные вычисления
- **openpyxl** — работа с Excel файлами
- **requests** — HTTP запросы к внешним API (MOEX ISS)

### Дополнительные зависимости
- **pathlib** — работа с путями файлов
- **dataclasses** — структуры данных
- **typing** — типизация кода
- **csv**, **json** — работа с форматами данных

### Среда разработки
- **Jupyter Notebooks** — интерактивные демонстрации и эксперименты
- **nbformat** — программная работа с блокнотами

## Инструкции по запуску

### Предварительные требования
```bash
pip install pandas numpy openpyxl requests
```

### Базовое использование

#### 1. Конвертация TVR2 ↔ Excel
```python
from converters import tvr2_to_excel, excel_to_tvr

# TVR2 → Excel
tvr2_to_excel('input.tvr2', 'output.xlsx')

# Excel → TVR2  
excel_to_tvr('input.xlsx', 'output.tvr2')
```

#### 2. Работа с портфелем инструментов
```python
from src.tvr_service.pipeline import build_portfolio, load_securities

# Построение портфеля на основе рыночных данных
portfolio = build_portfolio(
    capital=1000000,  # Капитал в рублях
    suffix='0',       # Фильтр по окончанию тикера
    prefer_remote=True # Загрузка данных с MOEX
)
```

#### 3. Генерация робота из шаблона
```python
from src.tvr_service.generator import generate_robot_segment

# Генерация сегмента робота
result = generate_robot_segment(
    source_tvr_path='template.tvr2',
    base_strokas=[1, 10],           # Базовые строки
    base_assignment={1: 100, 10: 110}, # Назначение новых номеров
    sec0_value='Si',                # Инструмент
    output_tvr_path='generated.tvr2',
    output_excel_path='generated.xlsx'
)
```

### Интерактивные демонстрации

Запустите Jupyter Notebook и откройте любой из демонстрационных блокнотов в папке `docs/`:

```bash
jupyter notebook docs/portfolio_testing_demo.ipynb
```

### Скрипты отладки и анализа

- `debug_dups.py` — поиск дубликатов в mask.xlsx
- `dump_cells.py` — извлечение ячеек из notebook файлов  
- `inspect_nb.py` — инспекция содержимого notebook

## Структура папок

```
constructor_TVR/
├── src/tvr_service/           # Основной код библиотеки
│   ├── api/                   # API интерфейсы
│   ├── generator/             # Генерация роботов и шаблонов
│   ├── io/                    # Ввод/вывод TVR файлов
│   ├── model/                 # Модели данных и парсеры
│   ├── pipeline/              # Конвейеры обработки (портфели, конфигурации)
│   └── templates/             # Шаблоны стратегий
├── docs/                      # Документация и демо-блокноты
│   ├── *.ipynb               # Jupyter демонстрации
│   ├── *.xlsx                # Шаблоны и примеры конфигураций
│   └── parameter_plan.md     # План развития параметризации
├── my_experiments/            # Экспериментальные разработки
├── converters.py              # Конвертеры TVR2 ↔ Excel
├── tvr_df.py                  # Утилиты работы с TVR данными
├── *.tvr2                     # Примеры TVR файлов
└── *.xlsx                     # Примеры Excel файлов
```

### Описание ключевых папок

- **`src/tvr_service/`** — основная библиотека с модульной архитектурой
- **`docs/`** — документация, демонстрации и шаблоны для работы
- **`my_experiments/`** — экспериментальные разработки и исследования
- **Корневая папка** — утилиты, примеры файлов и скрипты быстрого старта

## Быстрый старт

1. **Изучите примеры**: начните с `docs/portfolio_testing_demo.ipynb`
2. **Попробуйте конвертацию**: используйте `converters.py` для работы с TVR2 файлами
3. **Создайте портфель**: запустите построение портфеля инструментов
4. **Сгенерируйте робота**: используйте шаблоны для создания торговых конфигураций

## Примеры файлов

В проекте включены готовые примеры:
- `Default.tvr2` — базовый шаблон робота
- `mask.xlsx` — шаблон маски для параметризации
- `generated_*.tvr2` — примеры сгенерированных конфигураций

Система готова к использованию и может быть расширена для специфических торговых задач.
