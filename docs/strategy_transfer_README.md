# Перенос стратегии на другие строки TVR

## Описание

Ноутбук `strategy_transfer.ipynb` предназначен для автоматического переноса стратегии с одних строк TVR на другие. Это полезно когда нужно:

- Перенести стратегию на другой инструмент
- Скопировать стратегию в другую область TVR файла
- Создать несколько копий стратегии для разных тикеров
- Реорганизовать структуру TVR файла

## Основные возможности

1. ✅ **Автоматический парсинг структуры** — система находит все связанные строки (фильтры, индикаторы)
2. ✅ **Просмотр структуры** — наглядное отображение всех элементов стратегии с их смещениями
3. ✅ **Изменение порядка** — возможность переставить элементы относительно друг друга
4. ✅ **Автоматическое обновление ссылок** — все внутренние ссылки обновляются автоматически
5. ✅ **Пакетный перенос** — возможность перенести стратегию сразу на несколько инструментов
6. ✅ **Экспорт в Excel и TVR** — результат сохраняется в обоих форматах

## Быстрый старт

### Шаг 1: Определите исходные строки

Откройте ваш TVR файл в Excel и найдите номера строк (stroka) базовых элементов стратегии:

```python
base_strokas = [3468, 3469]  # Например, лонг и шорт позиции
```

### Шаг 2: Укажите новую базовую строку

Определите, куда хотите перенести стратегию:

```python
new_base_stroka = 5000  # Новая позиция для базовой (лонг) строки
new_sec0_value = "SBER"  # Новый тикер
```

### Шаг 3: Запустите генерацию

Выполните все ячейки ноутбука — система автоматически:
- Найдет все связанные строки
- Создаст новый TVR файл
- Экспортирует результат в Excel

## Структура ноутбука

### Основные шаги

1. **Инициализация** — загрузка модулей
2. **Загрузка TVR** — чтение исходного файла
3. **Выбор базовых строк** — указание строк стратегии
4. **Парсинг структуры** — автоматический поиск связанных элементов
5. **Изменение порядка** (опционально) — ручная корректировка смещений
6. **Указание новой базы** — целевая позиция и тикер
7. **Компиляция** — подготовка к генерации
8. **Генерация** — создание нового TVR
9. **Проверка** — валидация результата

### Дополнительные инструменты

- **Пакетный перенос** — массовое создание стратегий для списка инструментов

## Примеры использования

### Пример 1: Простой перенос на другой тикер

```python
# Исходная стратегия на строках 3468-3469
base_strokas = [3468, 3469]

# Переносим на строку 5000 с тикером GAZP
new_base_stroka = 5000
new_sec0_value = "GAZP"

# Запустить генерацию (Шаги 7-8)
```

### Пример 2: Перенос с изменением порядка

```python
# Если нужно изменить смещения фильтров
edited_layout_text = """
#MME55_long: 0 : 0
##filter_1_InM: -1 : -5
##filter_1_OutM: -2 : -10
#MME55_short: 1 : 1
##filter_1_InM: -1 : -5
##filter_1_OutM: -2 : -10
"""

# Применить изменения (Шаг 4)
from src.tvr_service.generator.layout import parse_layout_text
layout_edits = parse_layout_text(layout, edited_layout_text)
```

### Пример 3: Пакетный перенос на несколько тикеров

```python
instruments = [
    {'ticker': 'SBER', 'base': 5000},
    {'ticker': 'GAZP', 'base': 6000},
    {'ticker': 'LKOH', 'base': 7000},
]

# Раскомментировать и выполнить код в последней ячейке
```

## Что получается на выходе

После выполнения генерации создаются:

1. **TVR файл** (`generated_transfer_TICKER.tvr2`) — готовый к использованию файл
2. **Excel файл** (`generated_transfer_TICKER.xlsx`) — для визуальной проверки
3. **Таблица соответствия** — mapping старых и новых номеров строк

## Важные моменты

### Про смещения

- **Смещение 0** — базовая строка (обычно лонг позиция)
- **Отрицательные смещения** — строки выше базовой (фильтры, индикаторы)
- **Положительные смещения** — строки ниже базовой (шорт позиция, дополнительные элементы)

### Про ссылки

Система автоматически обновляет все ссылки в столбцах:
- `InL1`, `InL2` — входные фильтры лонг
- `OutL1`, `OutL2` — выходные фильтры лонг
- `secIn`, `secOut` — фильтры по инструментам

### Про коллизии

Если новые строки пересекаются с существующими:
- Выберите другую `new_base_stroka`
- Или измените смещения в Шаге 4

## Устранение проблем

### Ошибка: "No base stroka from assignment covers node"

**Причина:** Указанные базовые строки не охватывают все элементы стратегии.

**Решение:** Добавьте недостающие базовые строки в `base_strokas`.

### Ошибка: "Collision: stroka X would be used by nodes"

**Причина:** Несколько элементов пытаются занять одну и ту же строку.

**Решение:** Измените смещения в Шаге 4 или выберите другую `new_base_stroka`.

### Результат пустой или неполный

**Причина:** Неправильно указаны базовые строки.

**Решение:** Проверьте номера строк в исходном Excel файле.

## Связанные файлы

- `strategy_mask_demo_v2.ipynb` — создание стратегии по маске
- `portfolio_advanced_demo.ipynb` — работа с портфелями
- `strategy_template_demo.ipynb` — работа с шаблонами

## Дополнительная информация

Для более глубокого понимания работы системы см.:
- `docs/overview.md` — общее описание проекта
- `docs/parameter_plan.md` — описание параметров
- `docs/relative_references_fix.md` — про относительные ссылки

---

**Автор:** TVR Constructor Team  
**Версия:** 1.0  
**Дата:** 2025-10-06

