# Подробная архитектурная документация Constructor TVR

## Введение

Constructor TVR представляет собой комплексную систему для работы с торговыми роботами, основанную на специализированном формате TVR2. Система разработана с модульной архитектурой, позволяющей гибко комбинировать различные компоненты для решения задач автоматизации торговли.

## Архитектурные принципы

### 1. Модульность
Система построена по принципу разделения ответственности:
- **IO слой** — работа с файлами и форматами данных
- **Model слой** — структуры данных и бизнес-логика
- **Generator слой** — создание новых конфигураций
- **Pipeline слой** — сквозные процессы обработки
- **Templates слой** — шаблонизация и параметризация

### 2. Расширяемость
Каждый модуль может быть независимо модифицирован и расширен без влияния на остальные компоненты.

### 3. Типизация
Активное использование Python typing для обеспечения корректности кода и улучшения читаемости.

## Детальное описание модулей

### src/tvr_service/

#### api/ - API интерфейсы
*Пустой модуль, зарезервированный для будущих внешних API интерфейсов*

**Назначение**: Планируется для создания REST API или других внешних интерфейсов доступа к функциональности системы.

#### generator/ - Генерация роботов и конфигураций

**Ключевые модули:**

**`robot_builder.py`** - Основной генератор робот-сегментов
- `generate_robot_segment()` — создание TVR фрагмента на основе базовых строк
- `build_dataframe_from_robot()` — конвертация парсированного робота в DataFrame
- Управление маппингом строк и разрешение конфликтов номеров

**`strategy_builder.py`** - Высокоуровневая генерация стратегий
- `StrategyGenerator` — класс для массовой генерации стратегий из шаблонов
- `generate()` — рендеринг таблиц конфигурации в TVR DataFrame
- Обработка контекста, переопределений и разделителей

**`layout.py`** - Работа со структурой layout'ов
- `StructureLayout` — представление структуры робота относительно базовых строк
- `build_layout_from_source()` — построение layout из TVR файла
- `parse_layout_text()` — парсинг отредактированного пользователем layout'а
- `compile_layout()` — преобразование относительных смещений в абсолютные номера строк

#### io/ - Ввод/вывод данных

**`tvr_io.py`** - Основной модуль работы с TVR2 файлами
- `read_tvr2()` — чтение TVR2 в DataFrame с метаданными
- `write_tvr2()` — запись DataFrame обратно в TVR2 формат
- `iter_tvr2_triplets()` — итерация по тройкам (stroka, stolbec, value)
- `TVRFile` — контейнер для данных TVR с метаданными форматирования

**Особенности:**
- Поддержка различных разделителей и кодировок
- Автоматическое определение структуры файла
- Валидация данных при чтении/записи

#### model/ - Модели данных и парсеры

**`normalized.py`** - Нормализованное представление TVR
- `TVRNormalized` — структура для работы с табличными данными TVR
- `load_and_normalize()` — загрузка и нормализация TVR файлов
- Обработка ссылочных колонок и разрешение зависимостей

**`parser.py`** - Парсер структур роботов
- `ParsedRobot` — представление робота как графа взаимосвязанных узлов
- `ParsedNode` — узел графа с относительными позициями и ссылками
- `parse_robot()` — парсинг TVR структуры в граф
- `parse_robot_from_file()` — парсинг из файла

**Ключевые концепции:**
- **Base stroka** — базовые строки, определяющие корневые узлы робота
- **Relative positions** — относительные позиции узлов относительно базовых строк
- **Reference columns** — колонки, содержащие ссылки на другие строки
- **Mode labels** — метки режимов торговли (long/short)

#### pipeline/ - Конвейеры обработки

**`portfolio.py`** - Управление портфелями инструментов
- `build_portfolio()` — создание портфеля с равным распределением капитала
- `load_securities()` — загрузка данных по инструментам (локально или с MOEX)
- `filter_by_suffix()`, `filter_by_whitelist()` — фильтрация инструментов
- `PortfolioEntry` — запись о распределении по инструменту

**Интеграции:**
- MOEX ISS API для получения актуальных данных по фьючерсам
- Поддержка whitelist'ов и автоматической генерации TB/TI пар
- Расчет полной стоимости позиций и гарантийного обеспечения

**`config_table.py`** - Построение конфигурационных таблиц
- `build_config_table()` — создание таблицы конфигураций через произведение параметров
- `enumerate_parameter_rows()` — перечисление всех комбинаций параметров
- Поддержка шаблонизации названий стратегий

**`top_futures.py`** - Работа с топовыми фьючерсами
- `get_top_futures()` — получение наиболее ликвидных фьючерсов
- `fetch_forts_history()` — загрузка исторических данных
- `rank_top_futures()` — ранжирование по объемам торгов

#### templates/ - Шаблоны стратегий

**`strategy_template.py`** - Основа системы шаблонов
- `StrategyTemplate` — полное описание шаблона стратегии
- `TemplateRow` — описание строки шаблона с параметрами по умолчанию
- `instantiate()` — создание конкретных записей из шаблона

**`mask_template.py`** - Создание шаблонов из mask-таблиц
- `build_template_from_mask_df()` — конвертация mask DataFrame в шаблон
- `build_template_from_mask_file()` — загрузка mask из Excel/CSV
- Поддержка маркеров для определения параметризуемых ячеек

**`naming.py`** - Система именования и алиасов
- `ColumnAliasMapper` — маппинг между именами колонок и алиасами
- `sanitize_token()` — нормализация имен для использования в коде
- `build_cell_mapping()` — создание маппинга ячеек для переопределений

### Корневые модули

**`converters.py`** - Конвертеры между форматами
- `tvr2_to_excel()` — конвертация TVR2 в Excel с метаданными
- `excel_to_tvr()` — обратная конвертация Excel в TVR2
- `TVRParams` — параметры конвертации (разделители, кодировки)

**Особенности:**
- Сохранение и восстановление метаданных через отдельный лист
- Поддержка различных десятичных разделителей
- Автоматическое определение структуры файлов

**`tvr_df.py`** - Утилиты работы с TVR данными
- `TVR_transform()` — преобразование TVR с расчетами GO/стоимости
- `TVR_asis()` — чтение TVR без изменений
- Интеграция со справочными данными по инструментам

## Схема взаимосвязей модулей

```
                    ┌─────────────────┐
                    │   converters.py │
                    │                 │
                    │  TVR2 ↔ Excel   │
                    └─────────────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │   tvr_service   │
                    └─────────────────┘
                             │
          ┌──────────────────┼──────────────────┐
          ▼                  ▼                  ▼
    ┌──────────┐      ┌──────────┐      ┌──────────┐
    │    IO    │      │  Model   │      │Generator │
    │          │      │          │      │          │
    │ tvr_io   │◄────►│normalized│◄────►│robot_    │
    │          │      │parser    │      │builder   │
    └──────────┘      └──────────┘      └──────────┘
          │                  │                  │
          ▼                  ▼                  ▼
    ┌──────────┐      ┌──────────┐      ┌──────────┐
    │Pipeline  │      │Templates │      │   API    │
    │          │      │          │      │          │
    │portfolio │      │strategy_ │      │(future)  │
    │config_   │      │template  │      │          │
    │table     │      │mask_temp.│      │          │
    └──────────┘      └──────────┘      └──────────┘
```

### Потоки данных

1. **Чтение TVR** → `tvr_io.read_tvr2()` → `normalized.load_and_normalize()` → `parser.parse_robot()`

2. **Генерация робота** → `robot_builder.generate_robot_segment()` → `tvr_io.write_tvr2()`

3. **Создание шаблона** → `mask_template.build_template_from_mask_file()` → `strategy_template.StrategyTemplate`

4. **Массовая генерация** → `config_table.build_config_table()` → `strategy_builder.StrategyGenerator.generate()`

## Ключевые алгоритмы

### 1. Парсинг структуры робота

```python
def parse_robot(normalized: TVRNormalized, base_strokas: Sequence[int]) -> ParsedRobot:
    """
    1. Для каждой base_stroka создается корневой узел
    2. Рекурсивно обходятся ссылки в reference_columns
    3. Строится граф зависимостей с relative positions
    4. Определяются shared узлы (используемые несколькими base)
    """
```

### 2. Генерация robot сегмента

```python
def generate_robot_segment(source_tvr_path, base_strokas, base_assignment):
    """
    1. Парсинг исходного TVR в граф
    2. Построение маппинга stroka номеров с учетом base_assignment
    3. Рендеринг узлов графа в новые строки DataFrame
    4. Разрешение ссылок на новые номера строк
    5. Запись результата в TVR2 и Excel
    """
```

### 3. Создание шаблона из mask

```python
def build_template_from_mask_df(mask_df, marker=1):
    """
    1. Определение value колонок (исключая metadata)
    2. Для каждой строки: создание TemplateRow с offset
    3. Для маркированных ячеек: создание override колонок
    4. Для немаркированных: использование значений как defaults
    5. Создание ColumnAliasMapper для колонок
    """
```

## Особенности архитектуры

### 1. Система относительных позиций

Каждый узел робота хранит относительные позиции относительно всех base_stroka, что позволяет:
- Переносить фрагменты роботов в новые позиции
- Обнаруживать конфликты при слиянии
- Автоматически пересчитывать ссылки

### 2. Шаблонизация с контекстом

Шаблоны поддерживают:
- Плейсхолдеры `{{variable}}` с подстановкой из контекста
- Callable функции для динамического вычисления значений
- Переопределения на уровне строк и ячеек

### 3. Конвейерная обработка

Pipeline модули предоставляют:
- Высокоуровневые функции для типовых задач
- Интеграцию с внешними источниками данных
- Кэширование и оптимизацию запросов

### 4. Валидация и обработка ошибок

Система включает:
- Проверку целостности данных на каждом этапе
- Детальные сообщения об ошибках с контекстом
- Graceful обработку отсутствующих данных

## Точки расширения

### 1. Новые источники данных
- Добавление новых провайдеров в `pipeline/`
- Расширение `portfolio.py` для работы с другими рынками

### 2. Дополнительные форматы
- Новые конвертеры в `converters.py`
- Расширение `io/` для поддержки других форматов

### 3. Алгоритмы генерации
- Новые генераторы в `generator/`
- Расширение системы шаблонов в `templates/`

### 4. API интерфейсы
- REST API в `api/` модуле
- WebSocket для real-time обновлений

## Планы развития

По документу `docs/parameter_plan.md` планируется:

1. **Инвентаризация ячеек** — полное описание доступных параметров
2. **YAML/JSON конфигурации** — декларативное описание параметров
3. **Применение значений** — улучшенный механизм подстановки
4. **Интеграция с генератором** — seamless параметризация
5. **Пакетная генерация** — массовое создание роботов

Система готова к использованию и активному развитию в направлении автоматизации торговых процессов.
